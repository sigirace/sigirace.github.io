## Services

ğŸ“Œ **íŒŒë“œì˜ ë¬¸ì œì **

- íŒŒë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ë‚´ë¶€ì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì™¸ë¶€ì™€ í†µì‹ ì´ ì•ˆë¨
- ìŠ¤ì¼€ì¼ë§ì— ëŒ€í•œ IPì— ëŒ€í•œ ì§€ì†ì ì¸ ë³€ë™, ë¡œë“œë°¸ëŸ°ì‹± ë¬¸ì œê°€ ë°œìƒ

[image/ service.pod_problem]



### ğŸ“ì„œë¹„ìŠ¤ ìš”êµ¬ì‚¬í•­

- ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ê°€ í”„ë¡ íŠ¸ì—”ë“œ íŒŒë“œì— í•­ìƒ ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼í•¨
- í”„ë¡ íŠ¸ì—”ë“œëŠ” ë‹¤ì‹œ ë°±ì—”ë“œë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼í•¨
- íŒŒë“œì˜ IPê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì¬ì„¤ì • í•˜ì§€ ì•Šë„ë¡ í•´ì•¼í•¨

[image/ service.rfp]



### ğŸ“ ì„œë¹„ìŠ¤ì˜ ìƒì„± ë°©ë²•

- kbuectlì˜ `expose`
- `yaml`



ğŸŒˆ **ì˜ˆì‹œ**

ğŸ“’ **sevice yaml**

```yaml
apiVersion: v1
kind: Service
metadata:
	name: http-go-svc
spec:
	ports:
	-	port: 80
		targetPort: 8080
  selector:
  	app: http-go
```

- kind: `Service`
- spec: ì–´ë–»ê²Œ ì„œë¹„ìŠ¤ë¥¼ í•  ê²ƒì¸ê°€
  - port: ì„œë¹„ìŠ¤ì˜ í¬íŠ¸
  - targetPort: íŒŒë“œì˜ í¬íŠ¸
- selector: pod ì„ íƒì˜ ê¸°ì¤€
  - ë¡œë“œë°¸ëŸ°ì‹±í•´ì£¼ê¸° ìœ„í•¨

**1. ìƒì„±**

```
kubectl create -f [svc].yaml
```

**2. í™•ì¸**

```yaml
kubectl get svc
```



## â¤ï¸â€ğŸ”¥ ClusterIP

- ìì²´ IPì™€ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ê°€ì§
- í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ìš©ìœ¼ë¡œ íŒŒë“œì— ë¡œë“œ ë°¸ëŸ°ì‹± ê¸°ëŠ¥ì„ ê°–ì¶¤



ğŸ“Œ  **ì„œë¹„ìŠ¤ IP ì •ë³´ í™•ì¸**

```
kubectl describe svc [service_name]
```



ğŸ“Œ **ì„¸ì…˜ ê³ ì •í•˜ê¸°**

- ì„œë¹„ìŠ¤ê°€ ë‹¤ìˆ˜ì˜ íŒŒë“œë¡œ êµ¬ì„±ë˜ë©´ ì›¹ì„œë¹„ìŠ¤ì˜ ì„¸ì…˜ì´ ìœ ì§€ë˜ì§€ ì•ŠìŒ
- ì²˜ìŒ ì ‘ì†í•œ í´ë¼ì´ì–¸íŠ¸ IPë¥¼ ë™ì¼í•œ íŒŒë“œì— ì „ë‹¬í•˜ëŠ” ë°©ë²•ì´ í•„ìš”

```yaml
...
kind: Service
...
spec:
	sessionAffinity: ClientIP
...
```

- affinity: ì¹œë°€í•œ



ğŸ“Œ **ë‹¤ì¤‘ í¬íŠ¸ ì„œë¹„ìŠ¤ ë°©ë²•**

```yaml
...
kind: Service
...
spec:
	sessionAffinity: ClientIP
	ports:
  - name: ...
  	port: ...
  - name: ...
  	port: ...
...
```

- k8sì—ì„œ ë³µìˆ˜í˜•ì´ ë¶™ëŠ” ì†ì„± `-`ê°€ ë°°ì—´ì²˜ëŸ¼ ë‚˜ì—´ë¨

ğŸ“Œ **ì—”ë“œí¬ì¸íŠ¸**

- íŒŒë“œê°€ ì™¸ë¶€ì™€ í†µì‹ í•˜ê¸° ìœ„í•´ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì— ì„œë¹„ìŠ¤ ìƒì„±



### âœï¸ ì‹¤ìŠµ

**1. Deployment ìƒì„±**

```
kubectl create deploy --image=sigirace/http-go:v1 http-go --dry-run=client -o yaml > http-go-deploy.yaml
```

ğŸ“’ **[name]-deploy.yaml**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: http-go
  name: http-go
spec:
  replicas: 1
  selector:
    matchLabels:
      app: http-go
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: http-go
    spec:
      containers:
      - image: sigirace/http-go:v1
        name: http-go
        resources: {}
status: {}
```



**2. Service ì¶”ê°€**

```yaml
apiVersion: v1
kind: Service
metadata:
	name: http-go-svc
spec:
	selector:
		app: http-go
  port:
  	-	protocol: TCP
  		port: 80
  		targetPort: 8080
```

- port: svc
- targetPort: pod



**3. ìƒì„±**

```
kubectl create -f http-go-deploy.yaml
```



**4. í™•ì¸**

```
kubectl get all
```

```
NAME                          READY   STATUS    RESTARTS   AGE
pod/http-go-96c8cc877-jcsgq   1/1     Running   0          4s

NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/http-go-svc   ClusterIP   10.108.48.97   <none>        80/TCP    4s
service/kubernetes    ClusterIP   10.96.0.1      <none>        443/TCP   47h

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/http-go   1/1     1            1           4s

NAME                                DESIRED   CURRENT   READY   AGE
replicaset.apps/http-go-96c8cc877   1         1         1       4s
```



**pod ìƒì„¸**

```
kubectl get pod -o wide
```

```
NAME                      READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES
http-go-96c8cc877-jcsgq   1/1     Running   0          114s   10.0.2.162   worker-2   <none>           <none>
```



**service ìƒì„¸**

```
kubectl decribe svc
```

```
Name:              http-go-svc
Namespace:         default
Labels:            <none>
Annotations:       <none>
Selector:          run=http-go
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.108.48.97
IPs:               10.108.48.97
Port:              <unset>  80/TCP
TargetPort:        8080/TCP
Endpoints:         <none>
Session Affinity:  None
Events:            <none>


Name:              kubernetes
Namespace:         default
Labels:            component=apiserver
                   provider=kubernetes
Annotations:       <none>
Selector:          <none>
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.96.0.1
IPs:               10.96.0.1
Port:              https  443/TCP
TargetPort:        6443/TCP
Endpoints:         192.168.243.131:6443
Session Affinity:  None
Events:            <none>
```

- ì›ë˜ EndPointsì— ìˆì–´ì•¼í•˜ëŠ”ë° ì˜¤ë¥˜ë‚˜ë„¤



## ğŸ“ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œí•˜ëŠ” ì„¸ ê°€ì§€ ë°©ë²•

1. **NodePort**

> ë…¸ë“œì˜ ê³ ì •ëœ í¬íŠ¸ë¥¼ í†µí•´ ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ íŒŒë“œë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•©ë‹ˆë‹¤.

- **íŠ¹ì§•**:
  - ê¸°ë³¸ì ìœ¼ë¡œ `ClusterIP`ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
  - í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê°„ë‹¨í•œ ë°©ë²•.
  - í´ëŸ¬ìŠ¤í„°ì˜ ê° ë…¸ë“œì—ì„œ ì§€ì •ëœ í¬íŠ¸ë¥¼ ì—´ì–´ì•¼ í•©ë‹ˆë‹¤.
- **í™œìš©**:
  - `NodePort`ëŠ” `LoadBalancer`ë‚˜ `Ingress` ì„¤ì •ì˜ ê¸°ë°˜ì´ ë©ë‹ˆë‹¤.

2. **LoadBalancer**

> í´ë¼ìš°ë“œ ì œê³µì—…ì²´ê°€ ì œê³µí•˜ëŠ” ì™¸ë¶€ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ í™œìš©í•˜ì—¬ íŠ¸ë˜í”½ì„ íŠ¹ì • ë…¸ë“œë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.

- **íŠ¹ì§•**:
  - L4 ê³„ì¸µ(TCP/UDP)ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.
  - í´ë¼ìš°ë“œ í™˜ê²½(ì˜ˆ: AWS, GCP, Azure)ì—ì„œ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
  - ì™¸ë¶€ IP ì£¼ì†Œë¥¼ í• ë‹¹ë°›ì•„ ì„œë¹„ìŠ¤ì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **í™œìš©**:
  - í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ í´ëŸ¬ìŠ¤í„°ì˜ ì™¸ë¶€ ì ‘ê·¼ì„ í—ˆìš©í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

3. **Ingress**

> í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ **L7 ê³„ì¸µ(HTTP/HTTPS)** ë¡œ íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•˜ëŠ” ë¦¬ì†ŒìŠ¤ì…ë‹ˆë‹¤.

- **íŠ¹ì§•**:
  - í•˜ë‚˜ì˜ IP ì£¼ì†Œë¡œ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - URL ê²½ë¡œë‚˜ ë„ë©”ì¸ ì´ë¦„ì— ë”°ë¼ íŠ¸ë˜í”½ì„ íŠ¹ì • ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
  - ì™¸ë¶€ ì ‘ê·¼ì€ ë³´í†µ `NodePort`ë‚˜ `LoadBalancer`ì™€ í•¨ê»˜ êµ¬ì„±í•´ì•¼ ë™ì‘í•©ë‹ˆë‹¤.
- **í™œìš©**:
  - ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ê°™ì´ ë³µì¡í•œ íŠ¸ë˜í”½ ë¼ìš°íŒ…ì´ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©í•©ë‹ˆë‹¤.

ê¸°íƒ€: **ClusterIP**

- í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì„ ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
- **íŠ¹ì§•**:
  - ê¸°ë³¸ ì„œë¹„ìŠ¤ ìœ í˜•ìœ¼ë¡œ, ì™¸ë¶€ì—ì„œ ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
  - ê°™ì€ í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ë‹¤ë¥¸ íŒŒë“œë“¤ì´ í•´ë‹¹ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.



## â¤ï¸â€ğŸ”¥ NodePort

ğŸ“Œ **ë™ì‘ ì›ë¦¬**

```yaml
apiVersion: v1
kind: Service
metadata:
	name:	http-go-np
spec:
	type: NodePort
	ports:
  -	port: 80
  	targetPort: 8080
  	nodePort: 30001
  selector:
  	app: http-go
```

- í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œì— í¬íŠ¸ `nodePort`ë¥¼ ì˜¤í”ˆ
- 30001ë²ˆ í¬íŠ¸ë¡œ ë“¤ì–´ì˜¨ íŒ¨í‚·ì„ `kubeproxy`ê°€ ë°›ì•„ SVCì˜ ë£°(`targetPort`) ë“¤ì„ ì ìš©
- `RR` ë°©ì‹ì„ í†µí•´ ì ì ˆí•œ `pod`(`port`)ì— ì—°ê²°
- `pod`ê°€ ë‚´ë¶€ì— ì—†ê³  ë‹¤ë¥¸ ë…¸ë“œì— ìˆë‹¤ë©´ `kubeproxy`ë¥¼ í†µí•´ ë‹¤ë¥¸ ë…¸ë“œì™€ ì—°ê²°ë¨
  - `kubeproxy`ëŠ” ë‹¤ë¥¸ ë…¸ë“œì˜ `kubeproxy`ì™€ ì—°ê²°ë¨




ğŸ“Œ **ë…¸ë“œí¬íŠ¸ ì„œë¹„ìŠ¤ì˜ íŒ¨í‚· íë¦„**

[image/ service.packet]

- ì™¸ë¶€ì—ì„œ íŒ¨í‚·ì´ ë“¤ì–´ì˜¤ë©´ ë‚´ë¶€ cluterIPê°€ ë‹´ê¸´ iptablesë¥¼ ì‚¬ìš©
  - ë°©í™”ë²½ì²˜ëŸ¼ ë“¤ì–´ì˜¤ëŠ” ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ í¬ì›Œë”© ì œí•œ ë“± ì—­í• 
- Iptablesë¥¼ í†µí•´ ë¡œë“œë°¸ëŸ°ì‹± ìˆ˜í–‰



### ğŸŒˆ ë…¸ë“œí¬íŠ¸ ì‹¤ìŠµ

```yaml
apiVersion: v1
kind: Service
metadata:
  name: http-go-np
spec:
  type: NodePort
  selector:
    run: http-go
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      nodePort: 30001
```

- `nodePort`ë¥¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ëœë¤í•˜ê²Œ ìƒì„±ë¨

```
kubectl create -f http-go-np.yaml
```

```
service/http-go-np created
```

```
kubectl get svc
```

```
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
http-go-np   NodePort    10.101.244.24   <none>        80:30001/TCP   7s
kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP        10h
```

- `NodePort`ëŠ” EXTERNAL-IPë¥¼ ë°›ì§€ ì•Šìœ¼ë‚˜ Nodeì˜ IPë¡œ ì ‘ê·¼ í•  ìˆ˜ ìˆìŒ

ğŸ“Œ **GCP ë°©í™”ë²½ ì„¤ì •**

```
gcloud compute firewall-rules create http-go-svc-rule --allow=tcp:30001
```

ğŸ’¡ **ì ‘ê·¼**

```
curl 34.68.185.220:30001
Welcome! http-go-74fcf6b45c-fbczg
```



## â¤ï¸â€ğŸ”¥ LoadBalancer

- NodePort ì„œë¹„ìŠ¤ì˜ í™•ì¥ëœ ì„œë¹„ìŠ¤
- í´ë¼ìš°ë“œì—ì„œë§Œ ì„œë¹„ìŠ¤ ì‚¬ìš© ê°€ëŠ¥
- NodePort ëŒ€ì‹  LoadBalancer ì„¤ì •
- ë¡œë“œ ë°¸ëŸ°ì„œì˜ IP ì£¼ì†Œë¥¼ í†µí•´ ì„œë¹„ìŠ¤ì— ì•¡ì„¸ìŠ¤

ğŸŒˆ **ë¡œë“œ ë°¸ëŸ°ì„œ ì‹¤ìŠµ**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: http-go-lb
spec:
  type: LoadBalancer
  selector:
    run: http-go
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
```

```
kubectl create -f http-go-ld.yaml
```

```
kubectl get svc
```

```
lee689014@cloudshell:~/yaml (lyrical-carver-442711-k4)$ kubectl get svc
NAME          TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)        AGE
http-go-lb    LoadBalancer   34.118.228.236   34.123.60.38   80:32169/TCP   78s
```

- cloud ì„œë¹„ìŠ¤ ìƒì„±ê¹Œì§€ ì‹œê°„ì´ ê±¸ë¦¼ `<pending>` ìƒíƒœ
- ë¡œë“œë°¸ëŸ°ìŠ¤ ìƒì„±ë˜ë©´ `EXTERNAL-IP` ìƒì„±

```
curl 34.45.149.144
```

```
Welcome! http-go-74fcf6b45c-fbczg
```



## â¤ï¸â€ğŸ”¥ ì¸ê·¸ë ˆìŠ¤

> í•˜ë‚˜ì˜ IPë‚˜ ë„ë©”ì¸ìœ¼ë¡œ ë‹¤ìˆ˜ì˜ application ë˜ëŠ” ë‹¤ìˆ˜ì˜ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•´ì£¼ê¸° ìœ„í•œ ê¸°ëŠ¥ì„ ë‚´í¬í•˜ê³  ìˆìŒ

- API gatewayì™€ë„ ê°™ìŒ

[image/ service.ingress]

ğŸ“Œ **nginx-ingress**

- ì¿ ë²„ë„¤í‹°ìŠ¤ì— nginxë¥¼ pod í˜•íƒœë¡œ ë„ì›€
- ingress ì ìš©ì‹œ nginxê°€ ì½ì–´ì„œ ë™ì  ìƒì„±í•¨



ğŸŒˆ **ì¸ê·¸ë ˆìŠ¤ nginx ì„¤ì¹˜**

```
git clone https://github.com/kubernetes/ingress-nginx/
kubectl apply -k `pwd`/ingress-nginx/deploy/static/provider/baremetal/
kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io ingress-nginx-admission
```



ğŸ“’ **ì„œë¹„ìŠ¤ ìƒì„±**

```
kubectl create deployment http-go --image=gasbugs/http-go:ingress # ì¸ê·¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ìš© http-go
kubectl expose deployment http-go --port=80 --target-port=8080
```



ğŸŒˆ **ì¸ê·¸ë ˆìŠ¤ Rule ì„¸íŒ…**

```yaml
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: http-go-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /welcome/test
spec:
  rules:
    - http:
        paths:
          - pathType: Exact
            path: /welcome/test
            backend:
              service:
                name: http-go
                port: 
                  number: 80
EOF
```

```
kubectl get ing
```

```
NAME              CLASS    HOSTS   ADDRESS         PORTS   AGE
http-go-ingress   <none>   *       35.225.90.248   80      2m7s
```

- ì„œë¹„ìŠ¤ì™€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ê°™ì•„ì•¼í•¨





