## 26.1 VideoRepository

### 1. stoarge upload

```dart
final FirebaseStorage _storage = FirebaseStorage.instance;

  UploadTask uploadVideoFile(File video, String uid){
    final fileRef = _storage.ref().child(
        "/videos/$uid/${DateTime.now().millisecondsSinceEpoch.toString()}",
    );
    return fileRef.putFile(video);
}

```

- fileRef.putFile(video)ì˜ íƒ€ì…ì€ UploadTask
- UploadTaskëŠ” metadataë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° Nullì´ ì•„ë‹ˆë©´ ìƒì„±ëœ ê²ƒì„
- Storageì— ì—…ë¡œë“œ í–ˆë‹¤ë©´ ì´í›„ì—ëŠ” documentì— ì €ì¥



## 26.2 uploadVideoProvider

- fileUrl: task.ref.getDownloadURL()

### 1. document upload

```dart
Future<void> saveVideo(VideoModel data){
  await _db.collection("videos").add(data.toJson());
}
```



### 2. File cast

```dart
final XFile video;

...
  
File(widget.video.path)
```



### 3. Context

- ì—…ë¡œë“œ ì´í›„ í™”ë©´ ì „í™˜ì„ ìœ„í•´ì„œëŠ” viewModelì˜ functionì— contextë¥¼ ë„£ì–´ì¤Œ
- context.pushAndReplacement("/home")



## 26.3 Cloud Functions 

### 1. install

> flutter pub add cloud_functions
>
> flutterfire configure



### 2. Nodejs

- cloudfunction í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•¨

> firebase init functions

```
? What language would you like to use to write Cloud Functions? TypeScript
? Do you want to use ESLint to catch probable bugs and enforce style? No
âœ”  Wrote functions/package.json
âœ”  Wrote functions/tsconfig.json
âœ”  Wrote functions/src/index.ts
âœ”  Wrote functions/.gitignore
? Do you want to install dependencies with npm now? Yes
```



ğŸ“ **Trouble Shooting**

```
rm -rf node_modules
rm package-lock.json
npm cache clean --force
```

- ë²„ì „ ì•ˆë§ì•„ì„œ ì˜¤ë¥˜ë‚˜ëŠ” ê²½ìš°
- cache clean ìˆ˜í–‰ í›„ ë‹¤ì‹œ init



### 3. Code

ğŸ“’ **function/src/index.ts**

```typescript
import * as functions from "firebase-functions/v2";
import { getFirestore } from "firebase-admin/firestore";
import * as admin from "firebase-admin";

admin.initializeApp(); // Firebase Admin ì´ˆê¸°í™”

export const onVideoCreated = functions.firestore.onDocumentCreated(
  "videos/{videoId}",
  async (event) => {
    const snapshot = event.data;
    const videoId = event.params.videoId;

    if (snapshot) {
      await getFirestore().collection("videos").doc(videoId).update({
        "hello": "from functions"
      });
      console.log(`Video document ${videoId} updated with hello message.`);
    } else {
      console.error("No snapshot data available.");
    }
  }
);
```

- ê´€ë¦¬ì ëª¨ë“œë¼ê³  ìƒê°
- documentì—ëŠ” listení•  ê²½ë¡œ ì…ë ¥
- snapshotì€ ë°©ê¸ˆ ìƒì„±í•œ íŒŒì¼
- refë¥¼ ì¨ì•¼ ì‹¤ì œ Documentë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŒ



### 4. Deploy

> firebase deploy --only functions

ğŸ“ **Trouble Shooting**



ğŸ“’ **function/package.json**

```json
{
  "name": "functions",
  "scripts": {
    "build": "tsc",
    "build:watch": "tsc --watch",
    "serve": "npm run build && firebase emulators:start --only functions",
    "shell": "npm run build && firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "22"
  },
  "main": "lib/index.js",
  "dependencies": {
    "firebase-admin": "^11.5.0",
    "firebase-functions": "^4.2.0"
  },
  "devDependencies": {
    "typescript": "4.9.5",
    "firebase-functions-test": "^3.1.0"
  },
  "private": true
}
```

- ë²„ì „ë¬¸ì œë¡œì¸í•´ ê³¼ê±°ë²„ì „ìœ¼ë¡œ ì„¤ì •

ğŸ“’ **firebase.json**

```json
...
"functions": [
    {
      "source": "functions",
      "codebase": "default",
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ],
      "predeploy": [
        "yarn --cwd \"$RESOURCE_DIR\" run build"
      ]
    }
  ]
```

- yarnìœ¼ë¡œ ë³€ê²½



## 26.4 ffmpeg

### 1. store upload

```typescript
...
// ì‘ì—…ì„ í†µí•´ tmp í´ë”ì— íŒŒì¼ì„ ìƒì„±í•œ ìƒí™©
const storage = admin.storage();
const [file, _] = await storage.bucket().upload('/tmp/${snapshot.id}.jpg', {
  destination: 'thumnails/${snapshot.id}.hpg',
});
```



## 26.5 publicUrl

### 1.  public url

- uploadì˜ ê²°ê³¼ëŠ” fileê³¼ metadata

```typescript
await file.makePublic();
await snapshot.ref.update({"thumnailUrl": file.publicUrl()});
```

- storageì— ì˜¬ë¦° íŒŒì¼ì˜ ê²½ë¡œë¥¼ Pulbicìœ¼ë¡œ ì–»ì–´ì˜¤ê³ , documentì— ì—…ë¡œë“œ



### 2. index trick

- collectionì—ì„œ ì¡°ê±´ë¬¸ìœ¼ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì°¾ì•„ì˜¤ëŠ” ê²ƒì€ ë§¤ìš° ì˜¤ë˜ê±¸ë¦¼
- ë‚´ê°€ ì˜¬ë¦° ë°ì´í„°ë“¤ë§Œ ë³´ê¸°ìœ„í•´ì„œ ëª‡ê°€ì§€ ì •ë³´ë§Œ ë”°ë¡œ user ì»¬ë ‰ì…˜ í•˜ìœ„ì— ì €ì¥

