## 7. REST API

### 7.1 serializer detail info

**1. depth**

- id ê°’ì´ ì•„ë‹Œ objectì˜ ì†ì„±ìœ¼ë¡œ ë³´ì—¬ì¤Œ

```python
class ModelSerializer(Modelserializer):
  class Meta:
    model = Model
    fields = "__all__"
    depth = 1
```

- depthë¥¼ 1ë¡œ ì§€ì •í•˜ë©´ ê´€ê³„ê°€ ìˆëŠ” objectë¥¼ serializeí•œ ë‹¤ìŒì— ì „ë‹¬
- ì»¤ìŠ¤í„°ë§ˆì´ì§•ì— í•œê³„ ì¡´ì¬

**2. tiny serializer**

[Model_1's serializer]

```python
class TinyModel_1_Serializer(ModelSerializer):
  class Meta:
    model = Model_1
    fields = (
      "property1",
      "property2",
      ...
    )
```

[Model_2`s serializer]

```Python
class Model_2_Serializer(ModelSerializer):
	
  # property1ì€ Model_1ê³¼ ê´€ê³„ê°€ ìˆë„ë¡ Model_2ì— ì •ì˜í•¨
  property1 = TinyModel_1_Serializer()
  
  class Meta:
    model = Model_2
    fields = "__all__"
```

- ì»¤ìŠ¤í„°ë§ˆì´ì§• ëœ detail ì ìš©
- ì „ë‹¬í•  ë°ì´í„°ê°€ listì´ë©´ `TinyModelSerializer(many=True)`ë¡œ ì„¤ì •

### 7.2 Relation Dependency

**1. read_only**

- ëª¨ë¸ì„ í†µí•´ ë°ì´í„°ë¥¼ ì¶”ê°€ì‹œ Serializerë¥¼ ì‚¬ìš©í•´ì•¼í•¨
- ì´ë•Œ, ê´€ê³„ë¥¼ ì„¤ì •í•˜ì˜€ë‹¤ë©´ ê´€ê³„ì˜ ë°ì´í„°ë¥¼ ì „ë¶€ ì „ë‹¬í•´ì•¼ë˜ëŠ” ë¬¸ì œ ë°œìƒ

```Python
class Model_1_DetailSerializer(ModelSerializer):
  # property1ì€ Model_2ì™€ ê´€ê³„ê°€ ìˆìŒ
  property1 = TinyModel_2_Serializer(read_only=True)
  ...
  
  class Meta:
    model = Model_1
    fields = "__all__"
```

- `read_only=True`ë¥¼ ì‚¬ìš©í•˜ë©´ serializerì˜ `is_valid`í•¨ìˆ˜ê°€ ì •ë³´ë¥¼ ìš”êµ¬í•˜ì§€ ì•ŠìŒ -> ì¼ì‹œì ìœ¼ë¡œ í•´ê²°
- `is_valid` í•¨ìˆ˜ë¥¼ ì¶©ì¡±í•˜ì˜€ë”ë¼ë„ ì‹¤ì œ ê´€ê³„ë¥¼ ë§Œì¡±ì‹œí‚¤ì§„ ëª»í•˜ì˜€ê¸°ì— ë¬¸ì œ ë°œìƒ

**2. user**

- uesrì˜ ê²½ìš° ì¸ì¦ì„ í•˜ì—¬ ì•ˆì „í•œ ë°ì´í„°ë¥¼ ë„˜ê²¨ì¤Œ
- step1. requestë¡œ ë„˜ì–´ì˜¨ ì•ˆì „í•œ ë°ì´í„° ì‚¬ìš©
- step2. `save` í•¨ìˆ˜ì— argumentë¡œ ì „ë‹¬í•˜ì—¬ `validated_data`ì— ì¶”ê°€ì‹œí‚´

[views.py]

```python
if request.user.is_authenticated:
  if serializer.is_valid():
    new_data = serializer.save(user_property=request.property)

else:
  raise NotAuthenticated  
```

**3. other fields**

- ë‹¤ë¥¸ ë°ì´í„°ëŠ” ì¸ì¦ì„ ê±°ì¹˜ì§€ ëª»í•¨
- Serializerì—ì„œë„ read_onlyë¥¼ ì‚¬ìš©í•˜ì˜€ê¸°ì— ì•ˆì „í•˜ì§€ ëª»í•¨
- ì¶”ê°€ ë¡œì§ í•„ìš”

```python
if serializer.is_valid():
  # other_modelì€ frontì—ì„œ ë„˜ì–´ì˜¨ ê°’
  other_model_pk = request.data.get("other_model")
  if not other_model_pk:
    raise ParseError
  try:
    other_model = OtherModel.objects.get(pk=other_model_pk)
  except OtherModel.DoesNotExist:
    raise ParseError("other model is required.")
  new_data = serializer.save(user_property=request.property, other_property=other_model,)
```

**4. Many to Many field**

```python
new_data = serializer.save(user_property=request.property, other_property=other_model,)

# many to manyëŠ” í•„ìˆ˜ê°€ ì•„ë‹ˆê¸°ì— ì¼ë‹¨ ê°ì²´ ì €ì¥í•œ í›„ì— ìˆ˜í–‰
mtm_properties = request.data.get("mtm_list")
for mtm_property_pk in mtm_properties:
  try:
    mtm_property = MTM_MODEL.object.get(pk=mtm_property_pk)
  except MTM_MODEL.DoesNotExist:
    raise ParseError(f"MTM_MODEL with id {mtm_property_pk} not found")
  
  new_data.mtm_properties.add(mtm_property)
```

- many to many ê°ì²´ í™•ì¸ì‹œì— exceptê°€ ìƒì„±ë˜ë”ë¼ë„, ì´ë¯¸ ìƒˆë¡œìš´ ë°ì´í„°ëŠ” ë§Œë“¤ì–´ì ¸ dbì— ë“¤ì–´ê°
- 3ê°€ì§€ ì „ëµ
  - ê·¸ëƒ¥ ì¡°ìš©íˆ ë„˜ì–´ê°: pass
  - ë°ì´í„°ëŠ” ì €ì¥í•˜ê³  ë„˜ì–´ê°€ë˜ ì—ëŸ¬ëŠ” ë§í•´ì¤Œ: raise
  - ë°ì´í„°ë„ ì‚­ì œ: new_data.delete() -> raise

### 7.3 Transaction

- ëª¨ë“  ì½”ë“œê°€ ì„±ê³µí•˜ê±°ë‚˜ ì•„ë¬´ ê²ƒë„ ì„±ê³µí•˜ì§€ ì•Šê¸°ë¥¼ ì›í•  ë•Œ ì‚¬ìš©
  - all or nothing
  - djangoëŠ” ëª¨ë“  ì¿¼ë¦¬ ì‹¤í–‰ ì¦‰ì‹œ DBì— ì ìš©ë¨ -> ë°©ì§€ë¥¼ ìœ„í•´ transaction ì‚¬ìš©

```python
from django.db import transaction
...

try:
  with transaction.atomic():
    new_data = serialzier.save(
      user_property=request.user,
      property1=property1,
      ...
    )
    
    mtms = request.data.get("mtms")
    for mtm_pk in mtms:
      mtm_data = MTM_Model.objects.get(pk=mtm_pk)
      new_data.mtm_fields.add(mtm_data)
    serializer = ModelDetailSerialzier(new_data)
    return Response(serializer.data)
  except Exception:
  	raise ParseError("MTM Fields not found")
```

- ì• ì´ˆì— ìƒì„±ë˜ì§€ ì•Šë„ë¡í•¨
- transaction ì•ˆì— try-exceptì´ ìˆë‹¤ë©´ ì˜¤ë¥˜ë¥¼ ë°œê²¬í•˜ì§€ëª»í•˜ê³  ê·¸ëƒ¥ ìƒì„±ë¨

### 7.4 SerializerMethodField

- ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ê³„ì‚°í•´ì„œ í•„ë“œë¡œ ë§Œë“œëŠ” ê²½ìš°
- ë³´ëŠ” ì‚¬ëŒì— ë”°ë¼ ê°’ì´ ë‹¬ë¼ì§€ëŠ” í•„ë“œë¥¼ ë§Œë“œëŠ” ê²½ìš°

```python
class ModelSerializer(ModelSerialzier):
  
  custom_field = serialzier.SerializerMethodField()
  
  class Meta:
    model = Model
    fields = "__all__"
  
  def get_custom_field(self, object):
    return object.property
```

- í•¨ìˆ˜ ëª…ì€ field ëª… ì•ì— `get_`ì„ ë¶™ì—¬ì•¼í•¨
- DRFëŠ” í˜„ì¬ serializingí•˜ê³  ìˆëŠ” ì˜¤ë¸Œì íŠ¸ì™€ í•¨ê»˜ methodë¥¼ í˜¸ì¶œí•¨
  - objectë¥¼ ë°›ì•„ì¤„ parameterê°€ ìˆì–´ì•¼ í•¨

### 7.5 Serialzier Context

- serializerì—ì„œ contextë¡œ ì „ë‹¬í•œ ê°’ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ

[views.py]

```python
serialzier = ModelSerialzier(
	object,
	context={"key": "value"},
)
```

[serialziers.py]

```python
def get_custom_field(self, object):
  value = self.context["key"] # <= context ì ‘ê·¼ê°€ëŠ¥
  return value
```

- request ìì²´ë¥¼ ì „ë‹¬í•˜ì—¬ ì—¬ëŸ¬ê°€ì§€ ì •ë³´ë¥¼ í™œìš©í•  ìˆ˜ ìˆìŒ

### 7.6 Reverse Serializers

**ğŸŒˆ Example**

```
A-FK(B)
```

- Aê°€ Bì˜ ì†ì„±ì„ FKë¡œ ê°€ì§€ê³  ìˆìŒ

```
B.A_set
```

- A_setì€ ëª¨ë¸ Bì—ê²Œ, Bë¥¼ ê°€ë¦¬í‚¤ê³  ìˆëŠ” ëª¨ë“  ëª¨ë¸ Aë¥¼ ì „ë‹¬
- related_nameìœ¼ë¡œ ì ‘ê·¼í•¨
- ModelSerializerê°€ Objectì—ì„œ ìë™ìœ¼ë¡œ Parsing
- ëª¨ë¸ì— ì´ë¯¸ ìˆëŠ” ê²ƒì´ê¸°ì— get_ functionì„ ìˆ˜í–‰í•  í•„ìš”ê°€ ì—†ìŒ
- ë‹¨, ì—­ì ‘ê·¼ì„ ìˆ˜í–‰í•  ê²½ìš° ë„ˆë¬´ ë§ì€ ë°ì´í„°ê°€ ë¶ˆë ¤ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ pagenation í•„ìš”

### 7.7 Pagenation

- get ë°©ì‹ìœ¼ë¡œ íŒŒë¼ë¯¸í„°ë¥¼ ë˜ì§€ë©´ `query_params`ë¡œ í™•ì¸ í•  ìˆ˜ ìˆìŒ

```
value = request.query_params.get("key")
```

- pageë¥¼ ë°›ì•„ì„œ ì¹´ìš´íŒ…

```python
def get(self, request):
  try:
    page = request.query_params.get("page", 1)
    page = int(page)
  except ValueError:
    page = 1
```

- pageê°€ ì •ìˆ˜ë¡œ ë“¤ì–´ì˜¤ì§€ ì•ŠëŠ” ì—ëŸ¬ë¥¼ ë°©ì§€

```python
def get(self, request):
  ...
	page_size = 3
  start = (page-1) * page_size
  end = start + page_size
  data = self.get_object(pk)
  serializer = ModelSerialzier(
  	data.fkmodel.all()[start:end],
    many=True,
  )
```

### 7.8 File Uploads

**1. ì—…ë¡œë“œ ìœ„ì¹˜**

[config>settings.py]

```python
MEDIA_ROOT = "uploads"
MEDIA_URL = "photo-uploads/"
```

- MEDIA_URL: íŒŒì¼ì„ ë…¸ì¶œí•˜ëŠ” ë°©ë²•, userì—ê²Œ íŒŒì¼ ì ‘ê·¼ URLì„ ì „ë‹¬
  - `/`ë¡œ ëë‚˜ì•¼í•¨
  - í´ë”ëª…ìœ¼ë¡œ ì§€ì •í•  í•„ìš” ì—†ìŒ
- MEDIA_ROOT: íŒŒì¼ì´ ì‹¤ì œë¡œ ìˆëŠ” ìœ„ì¹˜

[config>urls.py]

```python
from django.conf.urls.static import static
from django.conf import settings

urlpartterns = [
  ...
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

- settingsë¥¼ Importì‹œì¼œ ì ‘ê·¼í•˜ë©´ ì•”í˜¸í™”ì— ì¢‹ìŒ

**2. íŒŒì¼ì„œë²„ ì ìš©**

- ëª¨ë¸ í•„ë“œ ìˆ˜ì •

```python
class Model():
  
  file = models.URLField()
```

### 7.9 permission_classes

```python
from rest_framework.permissions import IsAuthenticated

class View(APIView):
  
  permission_classes = [IsAuthenticated]
  
  ...
```

- IsAuthenticated: ëª¨ë‘ ì¸ì¦ í•„ìš”
- IsAuthenticatedOrReadOnly: getë§Œ ì¸ì¦ ì—†ì–´ë„ ê°€ëŠ¥
